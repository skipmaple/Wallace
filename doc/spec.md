# Wallace v4.2：拟人化桌面 AI 机器人

> **目标**：构建一个具备"听、说、看、感知、情感"能力的桌面语音助手，让 AI 真正"活"起来。
> **架构**：ESP32-S3（N32R16V）单芯片全栈方案 + PC 服务端协同处理。
> **版本更新**：v4.2 升级主控至 N32R16V（32MB Flash / 16MB PSRAM），DHT20 替换 DHT22（I2C 总线统一），新增 SD 卡本地存储，BOM 按实际采购更新。

---

## 目录

- [1. 项目概述](#1-项目概述)
- [2. 系统架构](#2-系统架构)
- [3. 硬件设计与引脚规划](#3-硬件设计与引脚规划)
- [4. 软件实现路线](#4-软件实现路线)
- [5. 拟人化体验设计](#5-拟人化体验设计)
- [6. AI 能力扩展](#6-ai-能力扩展)
- [7. 环境感知与智能家居](#7-环境感知与智能家居)
- [8. 趣味玩法](#8-趣味玩法)
- [9. 电源管理策略](#9-电源管理策略)
- [10. 硬件采购清单（BOM）](#10-硬件采购清单bom)
- [11. 已知问题与解决方案](#11-已知问题与解决方案)
- [12. 硬件形态创意](#12-硬件形态创意)
- [13. 开发路线图](#13-开发路线图)
- [附录 A：市场方案对比参考](#附录-a市场方案对比参考)
- [附录 B：开发调试建议](#附录-b开发调试建议)
- [附录 C：v4.2 相对 v4.1 变更摘要](#附录-c-v42-相对-v41-变更摘要)

---

## 1. 项目概述

### 核心体验

| 能力 | 描述 | 实现方式 |
|------|------|----------|
| **听** | 语音唤醒 + 语音采集 | ESP32-S3 本地运行唤醒词模型，持续监听 |
| **说** | 自然语音回复 | PC 端 LLM 生成文本，TTS 合成语音回传播放 |
| **看** | 圆形屏幕模拟眼睛 | 眨眼、注视、情绪表情等拟人化动效 |
| **感知** | 环境与用户感知 | 温湿度、光线、距离、空气质量 |
| **情感** | 情绪状态系统 | 根据对话内容展示喜怒哀乐等情绪 |
| **续航** | 电池供电，语音唤醒待机 | 预计 4-6 天待机（3000-3500mAh 电池） |

### v4.2 版本更新要点

```
┌─────────────────────────────────────────────────────────────────┐
│  v4.2 更新（相对 v4.1）                                         │
├─────────────────────────────────────────────────────────────────┤
│  🔧 硬件升级                                                    │
│     ├── 主控升级 N32R16V（32MB Flash / 16MB PSRAM）             │
│     ├── DHT20 替换 DHT22（I2C 接口，总线统一）                  │
│     ├── 电池升级 Samsung 18650 3000-3500mAh                     │
│     └── 新增 Micro SD 卡模块（本地存储）                        │
├─────────────────────────────────────────────────────────────────┤
│  💾 存储扩展（受益于 N32R16V）                                   │
│     ├── Flash 32MB：更大分区表，OTA 双分区                      │
│     ├── PSRAM 16MB：更大音频缓冲，更复杂的眼睛动画帧缓存       │
│     └── SD 卡：本地记忆存储、音效文件、日志                     │
├─────────────────────────────────────────────────────────────────┤
│  📋 BOM 状态                                                    │
│     └── 所有核心和扩展模块已采购到位                            │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 系统架构

### 2.1 硬件链路

```
┌─────────────────────────────────────────────────────────────────────┐
│                      ESP32-S3 N32R16V                                │
│                  (32MB Flash / 16MB PSRAM)                           │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │
│  │ WakeNet   │ │ Audio     │ │ Display   │ │ Sensors   │           │
│  │ 唤醒检测  │ │ I2S 音频  │ │ SPI 屏幕  │ │ I2C 传感  │           │
│  └─────┬─────┘ └─────┬─────┘ └─────┬─────┘ └─────┬─────┘           │
└────────┼─────────────┼─────────────┼─────────────┼──────────────────┘
         │             │             │             │
   ┌─────▼─────┐ ┌─────▼─────┐ ┌─────▼─────┐ ┌─────▼─────┐
   │ INMP441   │ │ MAX98357A │ │ GC9A01    │ │ I2C 总线  │
   │ 麦克风    │ │ 功放      │ │ 1.28"圆屏 │ │ 传感器组  │
   └───────────┘ └─────┬─────┘ └───────────┘ └───────────┘
                       │
                 ┌─────▼─────┐               ┌───────────┐
                 │ 腔体喇叭  │               │ WS2812B   │
                 │ 4Ω 3W    │               │ 12灯环形  │
                 └───────────┘               └───────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                      I2C 传感器总线（GPIO6/7）                        │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │
│  │ VL53L0X   │ │ BH1750    │ │ DHT20     │ │ MPU6050   │           │
│  │ 测距 0x29 │ │ 光线 0x23 │ │ 温湿 0x38 │ │ 姿态 0x68 │           │
│  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                         电源系统                                     │
│  Samsung 18650 (3.7V, 3000-3500mAh)                                 │
│    ──▶ TP4056 充电(Type-C) ──▶ MT3608 升压 5V ──▶ 各模块供电       │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                      新增/变更模块                                    │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐                         │
│  │ Micro SD  │ │ MQ-135    │ │ OV7670    │                         │
│  │ SPI存储   │ │ 空气质量  │ │ 摄像头    │                         │
│  └───────────┘ └───────────┘ └───────────┘                         │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 数据流向（语音唤醒模式）

```
┌─────────────────────────────────────────────────────────────────────┐
│  【待机监听状态】功耗 ~25mA                                          │
│                                                                     │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐                      │
│  │ INMP441  │───▶│ WakeNet  │    │ 闲置动画 │  眼睛随机看看四周    │
│  │ 麦克风   │    │ 唤醒检测 │    │ 屏幕显示 │  偶尔眨眼、打哈欠    │
│  └──────────┘    └────┬─────┘    └──────────┘                      │
│                       │                                             │
│                       │ 检测到唤醒词 "Hi Wallace"                   │
│                       ▼                                             │
├─────────────────────────────────────────────────────────────────────┤
│  【唤醒状态】                                                        │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  1. RGB 灯带亮起渐变光环                                      │  │
│  │  2. 屏幕显示"聆听"表情（眼睛睁大、瞳孔放大）                  │  │
│  │  3. WiFi 快速连接 PC 服务端                                   │  │
│  │  4. CPU 提升至 240MHz                                         │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                       │                                             │
│                       ▼                                             │
├─────────────────────────────────────────────────────────────────────┤
│  【录音上传】                                                        │
│                                                                     │
│  ┌──────────┐         ┌──────────┐         ┌──────────┐           │
│  │ 麦克风   │ ──I2S──▶│ 音频缓存 │ ──WS───▶│ PC服务端 │           │
│  │ 采集     │         │ PSRAM    │         │ 接收     │           │
│  └──────────┘         │ 16MB可用 │         └──────────┘           │
│                       └──────────┘                                 │
│  屏幕显示：眼睛专注看着用户，RGB 灯带呼吸闪烁                        │
│                       │                                             │
│                       ▼                                             │
├─────────────────────────────────────────────────────────────────────┤
│  【PC 端处理】                                                       │
│                                                                     │
│  ┌────────┐   ┌────────┐   ┌────────┐   ┌────────┐   ┌────────┐  │
│  │ VAD    │──▶│ ASR    │──▶│ 记忆   │──▶│ LLM    │──▶│ TTS    │  │
│  │ 静音检测│   │ 语音识别│   │ 注入   │   │ 生成回复│   │ 语音合成│  │
│  │Silero  │   │Whisper │   │ Context│   │DeepSeek│   │Edge-TTS│  │
│  └────────┘   └────────┘   └────────┘   └───┬────┘   └────────┘  │
│                                             │                      │
│                              提取情绪标签 [mood:happy]              │
│                       │                                             │
│                       ▼                                             │
├─────────────────────────────────────────────────────────────────────┤
│  【回复播放】                                                        │
│                                                                     │
│  ┌──────────┐         ┌──────────┐         ┌──────────┐           │
│  │ PC推送   │ ──WS───▶│ ESP32    │ ──I2S──▶│ 喇叭播放 │           │
│  │ 音频流   │         │ PSRAM缓存│         │          │           │
│  └──────────┘         └──────────┘         └──────────┘           │
│                                                                     │
│  屏幕显示：根据情绪标签切换表情 + 说话时嘴巴/波形律动                │
│  RGB 灯带：随音频振幅律动                                           │
│                       │                                             │
│                       ▼                                             │
├─────────────────────────────────────────────────────────────────────┤
│  【返回待机】                                                        │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  1. 断开 WiFi，CPU 降频至 80MHz                               │  │
│  │  2. 屏幕切换回闲置动画                                        │  │
│  │  3. RGB 灯带恢复淡蓝色呼吸                                    │  │
│  │  4. 继续监听唤醒词                                            │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. 硬件设计与引脚规划

### 3.1 核心模块引脚

#### 音频输入（INMP441 - I2S_NUM_0）

| INMP441 引脚 | ESP32-S3 GPIO | 说明 |
|-------------|---------------|------|
| SCK (BCLK)  | GPIO 41       | I2S 位时钟 |
| WS (LRC)    | GPIO 42       | I2S 字选择 |
| SD (DOUT)   | GPIO 2        | I2S 数据输出 |
| VDD         | 3.3V          | 供电 |
| GND         | GND           | 接地 |
| L/R         | GND           | 接地 = 左声道 |

#### 音频输出（MAX98357A - I2S_NUM_1）

| MAX98357A 引脚 | ESP32-S3 GPIO | 说明 |
|---------------|---------------|------|
| BCLK          | GPIO 15       | I2S 位时钟 |
| LRC           | GPIO 16       | I2S 字选择 |
| DIN           | GPIO 17       | I2S 数据输入 |
| Vin           | **5V**        | 供电（从 MT3608） |
| GND           | GND           | 接地 |

#### 视觉显示（GC9A01 - SPI）

| GC9A01 引脚 | ESP32-S3 GPIO | 说明 |
|------------|---------------|------|
| SCL (SCK)  | GPIO 12       | SPI 时钟 |
| SDA (MOSI) | GPIO 11       | SPI 数据 |
| RES (RST)  | GPIO 10       | 复位 |
| DC         | GPIO 9        | 数据/命令 |
| CS         | GPIO 46       | 片选 |
| BLK        | GPIO 45       | 背光 PWM |
| VCC/GND    | 3.3V / GND    | 供电 |

#### Micro SD 卡模块（SPI，与屏幕共用总线）

| SD 模块引脚 | ESP32-S3 GPIO | 说明 |
|------------|---------------|------|
| SCK        | GPIO 12       | SPI 时钟（共用） |
| MOSI       | GPIO 11       | SPI MOSI（共用） |
| MISO       | GPIO 13       | SPI MISO |
| CS         | GPIO 14       | 片选（独立） |
| VCC/GND    | 3.3V / GND    | 供电 |

> **注意**：SD 卡与 GC9A01 共用 SPI 总线，通过独立 CS 片选切换。屏幕刷新时避免同时读写 SD 卡。

#### RGB 灯带（WS2812B）

| WS2812B | ESP32-S3 GPIO | 说明 |
|---------|---------------|------|
| DIN     | GPIO 48       | 数据输入（支持 RMT） |
| VCC     | 5V            | 供电 |
| GND     | GND           | 接地 |

### 3.2 扩展模块引脚

#### I2C 总线（传感器共用）

| 功能 | ESP32-S3 GPIO |
|------|---------------|
| SDA  | GPIO 6        |
| SCL  | GPIO 7        |

#### I2C 设备地址表

| 模块 | I2C 地址 | 功能 | v4.1 对比 |
|------|---------|------|-----------|
| VL53L0X | 0x29 | 激光测距（眼神追踪） | 不变 |
| BH1750 (GY-302) | 0x23 | 光线感应 | 不变 |
| **DHT20** | **0x38** | **温湿度（I2C）** | **替换 DHT22（单总线→I2C）** |
| MPU6050 | 0x68 | 姿态检测（摇一摇） | 不变 |

> **v4.2 变更**：DHT20 使用 I2C 接口（地址 0x38），不再占用独立 GPIO。所有传感器统一走 I2C 总线，布线更简洁。

#### MQ-135 空气质量传感器（模拟量）

| MQ-135 引脚 | ESP32-S3 GPIO | 说明 |
|-------------|---------------|------|
| AO          | GPIO 4        | 模拟输出（ADC） |
| VCC         | 5V            | 供电（预热需 5V） |
| GND         | GND           | 接地 |

#### 摄像头（OV7670，可选）

| OV7670 引脚 | ESP32-S3 GPIO | 说明 |
|-------------|---------------|------|
| SIOD (SDA)  | GPIO 6        | I2C 共用 |
| SIOC (SCL)  | GPIO 7        | I2C 共用 |
| VSYNC       | GPIO 38       | 帧同步 |
| HREF        | GPIO 39       | 行同步 |
| PCLK        | GPIO 40       | 像素时钟 |
| D0-D7       | GPIO 18-21, 36-37, 47, 3 | 数据线 |
| XCLK        | GPIO 8        | 主时钟输出 |

> **注意**：OV7670 无 FIFO 版本需要较高的 CPU 实时处理能力。建议使用 OV7670+FIFO 版本，或仅在 N32R16V 的 16MB PSRAM 支持下使用无 FIFO 版本做低帧率抓拍。

#### 其他

| 模块 | ESP32-S3 GPIO | 说明 |
|------|---------------|------|
| TTP223 触摸 | GPIO 1 (RTC) | 备用手动唤醒 |
| 物理按钮 | GPIO 0 | 彩蛋触发 |
| 电池电压 | GPIO 5 (ADC) | 分压检测 |

### 3.3 引脚总览

```
ESP32-S3 N32R16V 引脚分配：

GPIO 0  ── 物理按钮（彩蛋）
GPIO 1  ── TTP223 触摸（RTC 唤醒）
GPIO 2  ── INMP441 SD（I2S0 数据输入）
GPIO 3  ── OV7670 D7（可选）
GPIO 4  ── MQ-135 AO（ADC 模拟输入）
GPIO 5  ── 电池电压 ADC
GPIO 6  ── I2C SDA（VL53L0X / BH1750 / DHT20 / MPU6050）
GPIO 7  ── I2C SCL
GPIO 8  ── OV7670 XCLK（可选）
GPIO 9  ── GC9A01 DC
GPIO 10 ── GC9A01 RST
GPIO 11 ── SPI MOSI（GC9A01 + SD 卡共用）
GPIO 12 ── SPI SCK（GC9A01 + SD 卡共用）
GPIO 13 ── SPI MISO（SD 卡）
GPIO 14 ── SD 卡 CS
GPIO 15 ── MAX98357A BCLK（I2S1）
GPIO 16 ── MAX98357A LRC（I2S1）
GPIO 17 ── MAX98357A DIN（I2S1）
GPIO 18-21 ── OV7670 D0-D3（可选）
GPIO 36-37 ── OV7670 D4-D5（可选）
GPIO 38 ── OV7670 VSYNC（可选）
GPIO 39 ── OV7670 HREF（可选）
GPIO 40 ── OV7670 PCLK（可选）
GPIO 41 ── INMP441 SCK（I2S0）
GPIO 42 ── INMP441 WS（I2S0）
GPIO 45 ── GC9A01 BLK（背光 PWM）
GPIO 46 ── GC9A01 CS
GPIO 47 ── OV7670 D6（可选）
GPIO 48 ── WS2812B DIN（RMT）
```

---

## 4. 软件实现路线

### 4.1 固件端（ESP32-S3）

**开发环境**：VS Code + PlatformIO（ESP-IDF 5.x 工具链）

**PlatformIO 配置（v4.2 更新）**：

```ini
; platformio.ini
[env:esp32s3]
platform = espressif32
board = esp32-s3-devkitc-1
framework = espidf

; 锁定 ESP-IDF 版本（与 ESP-SR/ESP-ADF 兼容）
platform_packages =
    framework-espidf @ ~5.1.0

; N32R16V PSRAM 配置（16MB OPI PSRAM）
board_build.arduino.memory_type = qio_opi
board_build.psram_mode = opi

; 串口配置
monitor_speed = 115200
upload_speed = 921600

; 额外组件路径（ESP-SR、ESP-ADF 等）
board_build.cmake_extra_args =
    -DEXTRA_COMPONENT_DIRS=${PROJECT_DIR}/components

; 分区表（v4.2：32MB Flash 扩展分区）
board_build.partitions = partitions_custom.csv
```

**自定义分区表（v4.2：32MB Flash）**：

```csv
# Name,     Type, SubType, Offset,    Size,      Flags
# ─── 系统区 ───
nvs,        data, nvs,     0x9000,    0x6000,
phy_init,   data, phy,     0xf000,    0x1000,
# ─── 应用区（OTA 双分区）───
ota_0,      app,  ota_0,   0x10000,   0x400000,   # 4MB 主应用
ota_1,      app,  ota_1,   0x410000,  0x400000,   # 4MB OTA 备份
# ─── 数据区 ───
model,      data, spiffs,  0x810000,  0x200000,   # 2MB 语音模型
audio,      data, spiffs,  0xA10000,  0x200000,   # 2MB 音效文件
storage,    data, spiffs,  0xC10000,  0x100000,   # 1MB 配置存储
# ─── 预留空间至 32MB ───
# 剩余约 19MB 可供后续扩展
```

> **v4.2 优势**：32MB Flash 支持 OTA 双分区（4MB×2），无需担心升级失败变砖。语音模型和音效文件各有 2MB 独立分区。

**核心框架/库**：

| 功能 | 方案 | 说明 |
|------|------|------|
| 屏幕驱动 | LovyanGFX | Sprite 局部刷新，16MB PSRAM 可缓存更多动画帧 |
| 音频框架 | ESP-ADF | I2S + 编解码 + 音频流水线 |
| 语音唤醒 | ESP-SR WakeNet / TFLite Micro | 本地唤醒词检测 |
| 指令识别 | ESP-SR MultiNet | 本地简单指令识别 |
| RGB 灯带 | FastLED / ESP-IDF RMT | WS2812B 驱动 |
| 传感器 | 各模块官方库 | I2C 统一总线读取 |
| SD 卡 | ESP-IDF SDMMC/SPI | 本地文件存储 |
| 网络通信 | WebSocket + MQTT | 服务端通信 + 智能家居 |

**固件架构**：

```
┌─────────────────────────────────────────────────────────────┐
│                      主任务调度                              │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │
│  │ 音频任务 │ │ 显示任务 │ │ 传感任务 │ │ 网络任务 │           │
│  │ Core 0  │ │ Core 1  │ │ Core 0  │ │ Core 1  │           │
│  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘           │
│       │          │          │          │                   │
│       ▼          ▼          ▼          ▼                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   事件队列                           │   │
│  │  WAKE_WORD_DETECTED | USER_PROXIMITY | IDLE_TIMEOUT │   │
│  └─────────────────────────────────────────────────────┘   │
│                          │                                 │
│                          ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   状态机                             │   │
│  │  IDLE → LISTENING → PROCESSING → SPEAKING → IDLE   │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘

PSRAM 16MB 内存分配（参考）：
  ┌──────────────────────────────────────┐
  │ 音频缓冲区          4MB              │  录音 + 播放双缓冲
  │ 屏幕帧缓存          2MB              │  240×240 双缓冲 + 动画精灵
  │ WakeNet 模型        2MB              │  唤醒词检测模型
  │ MultiNet 模型       2MB              │  本地指令模型
  │ 通用堆内存          6MB              │  网络缓冲、JSON 解析等
  └──────────────────────────────────────┘
```

### 4.2 语音唤醒方案

**推荐：混合策略（ESP32 预检 + PC 确认）**

#### 可选实现路径

| 方案 | 检测位置 | 延迟 | 准确率 | 复杂度 | 推荐场景 |
|------|---------|------|-------|-------|---------|
| A. ESP32 本地 KWS | 设备端 | <50ms | 中等 | 中 | 追求低延迟 |
| B. PC 端唤醒 | 服务端 | 100-300ms | 高 | 低 | 追求高准确率 |
| C. 混合策略 | 设备+服务端 | <100ms | 高 | 高 | 平衡方案（推荐）|

**混合策略时序优化**：

```
┌─────────────────────────────────────────────────────────────────┐
│  【优化并行方案】延迟 ≈ 50-100ms（推荐）                         │
│                                                                 │
│  用户说唤醒词 ──▶ ESP32预检 ──┬──▶ 立即开始录音（乐观执行）     │
│                    50ms       │                                 │
│                               └──▶ 同时上传PC确认               │
│                                         │                       │
│                               ┌─────────┴─────────┐             │
│                               ▼                   ▼             │
│                          PC确认通过          PC确认失败          │
│                          继续录音            丢弃已录内容        │
└─────────────────────────────────────────────────────────────────┘
```

#### 推荐开源工具链

| 工具 | 平台 | 特点 |
|------|------|------|
| **openWakeWord** | PC (Python) | 准确率高、支持自定义词训练 |
| **microWakeWord** | ESP32 | 专为 ESP32 优化、ESPHome 集成 |
| **Porcupine** | 跨平台 | 商业级准确率、有免费 tier |

#### 唤醒流程

```
持续监听 ──▶ 唤醒词检测 ──▶ 检测到唤醒词
                               │
                 ┌─────────────┴─────────────┐
                 ▼                           ▼
          后续是简单指令？              后续是复杂问题？
                 │                           │
                 ▼                           ▼
          MultiNet本地识别             上传PC服务端
          直接执行动作                 LLM处理回复
          （延迟 <100ms）              （延迟 ~1-3s）
```

### 4.3 服务端（PC）

**技术栈**：Python 3.10+ / FastAPI / WebSocket / MQTT

```python
# server.py
from fastapi import FastAPI, WebSocket
from langchain_ollama import ChatOllama
import faster_whisper
import edge_tts

app = FastAPI()

whisper = faster_whisper.WhisperModel("large-v3-turbo")
llm = ChatOllama(model="deepseek-r1:8b")

@app.websocket("/ws/{user_id}")
async def chat(websocket: WebSocket, user_id: str):
    await websocket.accept()

    while True:
        # 1. 接收音频
        audio_data = await websocket.receive_bytes()

        # 2. ASR
        segments, _ = whisper.transcribe(audio_data)
        text = "".join([s.text for s in segments])

        # 3. 注入记忆上下文
        context = get_user_context(user_id)
        prompt = f"{context}\n\n用户说：{text}"

        # 4. LLM 生成
        response = llm.invoke(prompt)
        reply = response.content

        # 5. 提取情绪 + 发送
        mood = extract_mood(reply)
        await websocket.send_json({"type": "mood", "mood": mood})

        # 6. TTS 流式推送
        communicate = edge_tts.Communicate(reply, voice="zh-CN-XiaoxiaoNeural")
        async for chunk in communicate.stream():
            if chunk["type"] == "audio":
                await websocket.send_bytes(chunk["data"])

        # 7. 更新记忆
        update_memory(user_id, text, reply)
```

---

## 5. 拟人化体验设计

### 5.1 情绪系统

| 情绪 | 触发条件 | 眼睛表现 | RGB 灯带 |
|------|---------|---------|---------|
| 😊 开心 | 正面回复、夸奖 | 弯成月牙，瞳孔放大 | 暖黄色快速呼吸 |
| 😢 难过 | 负面话题、道歉 | 下垂，泪滴动画 | 蓝色缓慢呼吸 |
| 🤔 思考 | 复杂问题、等待 | 向上看，瞳孔转圈 | 紫色流水 |
| 😠 生气 | 被骂、不满 | 眉毛下压，瞳孔缩小 | 红色闪烁 |
| 😴 困了 | 长时间空闲 | 慢慢眯起，打哈欠 | 暗淡橙色 |
| 😲 惊讶 | 意外信息 | 睁大，瞳孔放大 | 白色闪烁 |
| 😏 傲娇 | 特定性格模式 | 斜眼，微微上扬 | 粉色 |

> **v4.2 优势**：16MB PSRAM 可预加载所有情绪的多帧精灵动画到内存，切换无延迟。

### 5.2 眼神追踪

使用 VL53L0X 激光测距传感器检测用户距离，调整瞳孔大小和位置：

- 距离 < 500mm：瞳孔放大，直视（关注）
- 距离 500-1500mm：正常瞳孔
- 距离 > 1500mm：瞳孔缩小，眼睛微低（失落）

### 5.3 闲置动画

无交互时的自主行为：

| 动作 | 频率 | 说明 |
|------|------|------|
| 随机看四周 | 3-10秒 | 眼球移动后回正 |
| 眨眼 | 随机 | 快速双眨 |
| 打哈欠 | 低概率 | 配合 SLEEPY 表情 |
| 好奇注视 | 低概率 | 盯某个方向 |
| 哼小曲 | 极低概率 | 播放短音效（从 SD 卡读取） |

### 5.4 呼吸灯效果

WS2812B 12灯环形灯带状态映射：

| 系统状态 | 灯效 | 颜色 |
|---------|------|------|
| 待机 | 缓慢呼吸 | 淡蓝色 |
| 聆听 | 渐变光环 | 彩虹色 |
| 思考 | 追逐流水 | 紫色 |
| 说话 | 音频律动 | 蓝绿色 |
| 低电量 | 闪烁警告 | 红色 |

---

## 6. AI 能力扩展

### 6.1 记忆系统

用户记忆以 JSON 文件存储（PC 端 `memories/` 目录，可同步备份到 SD 卡）：

- 用户名、偏好、兴趣
- 最近 5 个话题
- 重要日期（生日等）
- 交互次数、首次见面时间

记忆上下文注入 LLM prompt，实现个性化对话。

### 6.2 主动关怀

定时任务 + 事件触发：

| 触发 | 动作 | 情绪 |
|------|------|------|
| 每 2 小时 | 久坐提醒 | caring |
| 每天 7:30 | 早安 + 天气 | happy |
| 每天 22:00 | 晚安提醒 | gentle |
| 特殊日期 | 生日/纪念日祝福 | excited |

### 6.3 多模态输入（可选）

OV7670 摄像头支持低帧率抓拍，用于：

- 人脸检测（调整眼神方向）
- 手势识别（简单交互）
- 场景拍照（上传 PC 端 LLM 分析）

### 6.4 本地指令识别

MultiNet 本地识别，无需联网：

| 指令 | 动作 |
|------|------|
| 打开灯 / 关闭灯 | MQTT 控制 |
| 调亮一点 / 调暗一点 | MQTT 亮度 |
| 播放音乐 / 暂停 | 本地音效或远程控制 |
| 现在几点 / 今天星期几 | 本地 RTC |
| 设置闹钟 / 取消闹钟 | 本地定时器 |

---

## 7. 环境感知与智能家居

### 7.1 环境传感器

| 传感器 | 型号 | 接口 | 功能 | 交互示例 |
|--------|------|------|------|---------|
| 温湿度 | **DHT20** | **I2C (0x38)** | 环境舒适度 | "现在室内26度，湿度60%" |
| 光线 | BH1750 (GY-302) | I2C (0x23) | 光照强度 | "光线有点暗，要不要开灯？" |
| 空气质量 | MQ-135 | ADC (GPIO 4) | 有害气体 | "空气质量不太好，建议开窗" |
| 距离 | VL53L0X | I2C (0x29) | 用户距离 | 自动调整眼神/唤醒 |

> **v4.2 变更**：DHT20 使用 I2C 接口，与其他传感器统一总线，无需额外 GPIO。相比 DHT22 的单总线协议，I2C 读取更稳定可靠。

### 7.2 智能家居联动

MQTT 协议对接，支持场景控制：

```
"睡觉" → 关灯 + 空调睡眠模式 + 说"晚安～"
"起床" → 灯光渐亮 + 说"早上好！"
```

---

## 8. 趣味玩法

### 8.1 小游戏模式

- **猜数字**：1-100，7 次机会
- **成语接龙**：LLM 辅助的中文成语接龙

### 8.2 桌面宠物模式

自主行为状态机：

| 属性 | 范围 | 影响 |
|------|------|------|
| 开心值 | 0-100 | 表情、互动意愿 |
| 能量值 | 0-100 | 活跃度，低于 20 犯困 |

互动方式：
- 触摸（TTP223）→ 开心 +10
- 喂食（说"吃东西"）→ 能量 +30
- 玩游戏 → 开心 +20，能量 -10

### 8.3 实用工具

- **番茄钟**：25 分钟专注 + 5 分钟休息
- **阅读助手**（需摄像头）：OCR 识别 + 单词解释

### 8.4 彩蛋功能

| 触发方式 | 功能 |
|---------|------|
| 物理按钮连按 3 下 | 切换性格（普通/高冷/话痨/傲娇） |
| 物理按钮长按 3 秒 | 树洞模式（只听不说，不记录） |
| 摇一摇（MPU6050） | 随机冷知识 |

---

## 9. 电源管理策略

### 9.1 供电架构

```
Samsung 18650 (3.7V, 3000-3500mAh)
    │
    ▼
 TP4056 充电保护模块 (Type-C)
    │
    ├──▶ MT3608 升压 ──▶ 5V
    │         │
    │         ├──▶ MAX98357A 功放
    │         ├──▶ WS2812B RGB 灯带
    │         ├──▶ MQ-135 空气传感器
    │         └──▶ ESP32-S3 (5V Pin)
    │                   │
    │                   └──▶ 板载 LDO ──▶ 3.3V
    │                                       │
    │                                       ├──▶ INMP441 麦克风
    │                                       ├──▶ GC9A01 屏幕
    │                                       ├──▶ Micro SD 模块
    │                                       └──▶ I2C 传感器组
    │
    └──▶ 电池电压检测 (ADC GPIO5)
              │
              └──▶ 低电量警告 (<3.3V)
```

### 9.2 功耗预估与续航

| 工作状态 | 功耗 | 说明 |
|---------|------|------|
| 语音唤醒待机 | ~25mA | 麦克风 + WakeNet + 闲置动画 |
| 唤醒后录音 | ~80mA | + WiFi 连接 |
| 播放回复 | ~150mA | + 功放全功率 + 屏幕最亮 |
| 全功能运行 | ~200mA | + RGB 灯带 + 传感器 |
| 深度睡眠 | ~10μA | 仅 RTC + 触摸唤醒 |

**续航估算（Samsung 18650 3000mAh）**：

| 使用模式 | 预估续航 |
|---------|---------|
| 纯语音唤醒待机（闲置动画开） | 约 100 小时（4.2 天） |
| 每天 50 次对话（每次 30 秒） | 约 4 天 |
| 深度睡眠 + 触摸唤醒 | 数月 |
| 全功能持续运行 | 约 15 小时 |

> **v4.2 提升**：相比 v4.1 的 2500mAh 电池，3000-3500mAh 电池续航提升约 20-40%。

### 9.3 低功耗优化策略

分级功耗管理：

| 等级 | CPU | 屏幕 | RGB | 传感器 | 触发条件 |
|------|-----|------|-----|--------|---------|
| FULL | 240MHz | 255 | 开 | 全部 | 对话中 |
| NORMAL | 160MHz | 200 | 开 | 关摄像头 | 日常待机 |
| SAVING | 80MHz | 100 | 关 | 仅麦克风 | 5分钟无交互 |
| ULTRA_LOW | 80MHz | 关 | 关 | 仅麦克风 | 电量 <3.3V |
| SLEEP | 停止 | 关 | 关 | 关 | 30分钟无交互 |

---

## 10. 硬件采购清单（BOM）

### 10.1 核心模块

| 类别 | 名称 | 规格 | 数量 | 状态 | 备注 |
|------|------|------|------|------|------|
| 主控 | ESP32-S3 开发板 | **N32R16V**，Type-C | 1 | ✅ 已购 | 32MB Flash / 16MB PSRAM |
| 主控（备用） | ESP32-S3 开发板 | N16R8，Type-C | 1 | ✅ 已购 | 备用/调试用 |
| 显示 | GC9A01 圆形屏 | 1.28寸 240×240 IPS 7针 | 2 | ✅ 已购 | 带底板 |
| 音频输入 | INMP441 麦克风 | I2S 数字麦克风 | 2 | ✅ 已购 | 一个焊针，一个备用 |
| 音频输出 | MAX98357A 功放 | I2S，3W D类，大芯片紫板 | 1 | ✅ 已购 | 需 5V 供电 |
| 发声 | 腔体喇叭 | 4Ω 3W，带音腔，杜邦线 | 1 | ✅ 已购 | 2831 腔体 |
| 电池 | Samsung 18650 | 3000mAh 10C 平头 | 4 | ✅ 已购 | |
| 电池 | Samsung 18650 | 3500mAh 3C 尖头 | 2 | ✅ 已购 | 续航优先选 3500mAh |
| 充电 | TP4056 模块 | Type-C，带保护 | 2 | ✅ 已购 | |
| 升压 | MT3608 模块 | DC-DC 2A | 2 | ✅ 已购 | 调至 5V |
| 灯效 | WS2812B 灯环 | 12灯，环形，黑板 | 1 | ✅ 已购 | |
| 交互 | TTP223 触摸 | 电容式 | 1 | ✅ 已购 | |
| 开关 | SS12D10 拨动开关 | 2档3脚 | 4 | ✅ 已购 | 总电源 |
| 连接 | XH2.54 端子线 | 2P/3P/4P，5-10cm | 批量 | ✅ 已购 | |
| 滤波 | 电解电容 | 100μF 25V | 批量 | ✅ 已购 | 升压滤波 |
| 存储 | Micro SD 模块 | SPI 接口 | 2 | ✅ 已购 | 本地存储 |

### 10.2 扩展模块

| 优先级 | 名称 | 规格 | 数量 | 状态 | 功能 |
|--------|------|------|------|------|------|
| ⭐⭐⭐⭐⭐ | VL53L0X | 激光测距 I2C，蓝板 | 1 | ✅ 已购 | 眼神追踪 |
| ⭐⭐⭐⭐⭐ | DHT20 | 温湿度 **I2C** | 1 | ✅ 已购 | 环境感知 |
| ⭐⭐⭐⭐ | BH1750 (GY-302) | 光线传感器 I2C | 1 | ✅ 已购 | 光线感知 |
| ⭐⭐⭐⭐ | MQ-135 | 空气质量（迷你型） | 1 | ✅ 已购 | 空气监测 |
| ⭐⭐⭐ | MPU6050 (GY-521) | 六轴姿态 I2C | 2 | ✅ 已购 | 摇一摇彩蛋 |
| ⭐⭐⭐ | 轻触按键 | 多种规格盒装 | 批量 | ✅ 已购 | 彩蛋触发 |
| ⭐⭐ | OV7670 | 摄像头模块 | 2 | ✅ 已购 | 人脸检测（可选） |

### 10.3 工具与辅材

| 名称 | 状态 | 备注 |
|------|------|------|
| 面包板 830孔 | ✅ 已购 | 原型阶段接线 |
| 电源线 RVB 2×0.75 | ✅ 已购 | 红黑并线 |
| M3 铜柱包 | ✅ 已购 | 固定用 |
| 18650 电池盒 | ✅ 已购 | 2节串联/并联 |
| 快速接线端子 | ✅ 已购 | 222 二进二出 |
| AMS1117 3.3V/5V | ✅ 已购 | 备用稳压 |
| 多路电源模块 DC-DC | ✅ 已购 | 3.3V/5V/12V |
| Type-C 插座 16P | ✅ 已购 | 自制供电口 |

### 10.4 采购注意事项

#### ⚠️ ESP32-S3 开发板 5V 引脚问题

**问题**：中国版 ESP32-S3 开发板 5V 引脚默认只有 ~1.8V。

**解决**：
1. 焊接短接板背面的 **IN-OUT 焊盘**
2. 或直接从 MT3608 输出 5V 给功放（推荐）

#### 其他注意事项

1. **主控必须是 N32R16V**：16MB PSRAM 是跑唤醒词模型 + 大缓冲的保障，32MB Flash 支持 OTA 双分区
2. **DHT20 注意地址冲突**：I2C 地址 0x38，确认与其他设备无冲突
3. **喇叭必须带音腔**：否则音质很差
4. **杜邦线尽量短**：I2S 信号超过 10cm 可能有杂音
5. **MQ-135 预热**：首次使用需预热 24 小时，之后每次启动预热约 1 分钟
6. **SD 卡与屏幕共用 SPI**：注意 CS 片选时序，避免同时操作

---

## 11. 已知问题与解决方案

### 11.1 I2S 驱动冲突

**问题**：同时使用麦克风和功放可能冲突。

**解决**：
- 使用 ESP-ADF 统一管理
- 麦克风用 I2S_NUM_0，功放用 I2S_NUM_1
- 不要混用新旧版 I2S 驱动

### 11.2 升压模块噪音

**问题**：MT3608 可能导致喇叭底噪。

**解决**：
- 输出端加 100μF 电解电容
- 升压模块远离麦克风
- I2S 线尽量短

### 11.3 唤醒词误触发

**问题**：电视等环境音误触发。

**解决**：
- 选择独特的唤醒词
- 调整检测阈值
- 混合策略 PC 端二次确认

### 11.4 WiFi 重连延迟

**问题**：唤醒后 WiFi 连接慢。

**解决**：
- 使用静态 IP
- 保存 WiFi 信道信息
- 考虑使用 ESP-NOW 替代部分场景

### 11.5 SPI 总线共用（v4.2 新增）

**问题**：SD 卡与 GC9A01 屏幕共用 SPI 总线，可能冲突。

**解决**：
- 使用独立 CS 片选引脚
- SD 卡读写操作加互斥锁
- 避免在屏幕刷新帧间隙之外操作 SD 卡
- SD 卡操作使用 DMA，不阻塞 CPU

### 11.6 DHT20 I2C 通信（v4.2 新增）

**问题**：DHT20 在 I2C 总线上响应较慢（~80ms 测量周期）。

**解决**：
- 降低采样频率（每 5-10 秒读取一次即可）
- 使用非阻塞 I2C 读取
- 温湿度读取放在低优先级任务中

---

## 12. 硬件形态创意

### 12.1 模块化设计

```
┌─────────────────┐
│   眼睛模块      │  ← 屏幕 + 主板 + 麦克风
│  (GC9A01+ESP32) │
├─────────────────┤
│   身体模块      │  ← 电池 + 传感器 + SD 卡
│  (可拆卸)       │
├─────────────────┤
│   底座模块      │  ← 灯带 + 喇叭 + 充电
│  (多种选择)     │
└─────────────────┘
```

### 12.2 外壳材质建议

| 材质 | 优点 | 缺点 | 推荐 |
|------|------|------|------|
| 3D 打印 PLA | 成本低、易定制 | 精度一般 | 原型阶段 |
| 3D 打印树脂 | 精度高、光滑 | 成本较高 | 小批量 |
| 亚克力 | 透明、质感好 | 需要切割加工 | 灯效展示 |
| 硅胶 | 手感好、可爱 | 需要开模 | 量产 |

---

## 13. 开发路线图

### Phase 1: 基础功能

```
□ 硬件组装与测试
  ├── ESP32-S3 N32R16V 上电测试
  ├── 5V 引脚修复（或 MT3608 直供）
  ├── 各模块单独验证（I2S/SPI/I2C）
  └── 整体连线（面包板原型）

□ 核心软件
  ├── GC9A01 屏幕驱动（LovyanGFX）
  ├── INMP441 录音测试（I2S_NUM_0）
  ├── MAX98357A 播放测试（I2S_NUM_1）
  ├── SD 卡读写测试（SPI 共用）
  └── WiFi + WebSocket 通信

□ 基础交互
  ├── 语音唤醒词集成
  ├── PC 服务端搭建（FastAPI）
  └── 端到端语音对话
```

### Phase 2: 拟人化体验

```
□ 情绪系统
  ├── 情绪状态定义与动画资源（PSRAM 预加载）
  ├── 眼睛动画实现（Sprite 双缓冲）
  └── LLM 情绪标签提取

□ 视觉反馈
  ├── WS2812B 灯带状态效果
  ├── 闲置动画
  └── 说话波形动效

□ 眼神追踪
  ├── VL53L0X 集成
  └── 瞳孔跟随逻辑
```

### Phase 3: 智能扩展

```
□ AI 能力
  ├── 记忆系统（PC JSON + SD 卡备份）
  ├── 本地指令识别（MultiNet）
  └── 主动关怀定时任务

□ 环境感知
  ├── DHT20 温湿度（I2C）
  ├── BH1750 光线
  ├── MQ-135 空气质量（ADC）
  └── 环境提醒逻辑

□ 智能家居
  ├── MQTT 协议对接
  └── 设备控制指令 + 场景
```

### Phase 4: 趣味玩法

```
□ 小游戏（猜数字、成语接龙）
□ 桌面宠物模式（状态机）
□ 彩蛋（性格切换、树洞模式、摇一摇）
```

### Phase 5: 优化打磨

```
□ 功耗优化与自动电源管理
□ OTA 升级支持（32MB Flash 双分区）
□ 响应速度优化
□ 外壳设计与制作
□ 文档与开源
```

---

## 附录 A：市场方案对比参考

| 维度 | ESP32-S3 N32R16V | 专用语音芯片 | 树莓派 |
|------|-----------------|------------|-------|
| 成本 | ¥50-70 | ¥50-100+ | ¥200+ |
| 功耗 | 25mA 监听 | <1mA | 500mA+ |
| Flash | 32MB | 4-16MB | SD 卡 |
| PSRAM | 16MB | 0-8MB | 1-8GB |
| 开发难度 | 中等 | 高 | 低 |
| 灵活性 | 高 | 低 | 高 |
| 电池续航 | 4-6 天 | 数周 | 几小时 |
| 适合场景 | DIY/桌面 | 专业产品 | 服务器 |

**结论**：ESP32-S3 N32R16V 在成本、功耗、灵活性之间取得了最佳平衡。相比 N16R8，翻倍的存储资源为 OTA、音效缓存、复杂动画提供了更充裕的空间。

---

## 附录 B：开发调试建议

### B.1 推荐开发顺序

1. **先跑通最小系统**：屏幕 + 麦克风 + 喇叭
2. **再加入唤醒词**：确保基础交互正常
3. **然后逐步扩展**：情绪、灯带、传感器
4. **最后优化打磨**：功耗、外壳、细节

### B.2 调试工具

| 工具 | 用途 |
|------|------|
| USB 串口 | 日志输出 |
| 万用表 | 电压/电流测量 |
| 逻辑分析仪 | I2S/SPI 信号分析 |
| Audacity | 音频录制/分析 |

### B.3 常见问题排查

```
问题：麦克风没声音
→ 检查 L/R 引脚是否接地
→ 检查 I2S 引脚配置
→ 用示波器/逻辑分析仪看 BCLK/WS 信号

问题：喇叭没声音
→ 检查 5V 供电是否正常（MT3608 输出）
→ 检查 I2S_NUM 是否正确（应该用 I2S_NUM_1）
→ 检查 SD 引脚是否悬空或接高

问题：屏幕不亮
→ 检查 BLK 背光引脚（GPIO 45）
→ 检查 SPI 引脚配置
→ 确认 CS 片选正确（GPIO 46）

问题：SD 卡读写失败（v4.2 新增）
→ 确认 CS 片选引脚（GPIO 14）独立于屏幕 CS（GPIO 46）
→ 检查 MISO 线（GPIO 13）是否连接
→ SD 卡格式化为 FAT32
→ 确认 SPI 频率不超过 20MHz（共用总线时降频）

问题：DHT20 读取失败（v4.2 新增）
→ 确认 I2C 地址 0x38
→ DHT20 上电后需等待 100ms 再读取
→ 检查 I2C 总线上拉电阻（4.7kΩ）
```

---

## 附录 C: v4.2 相对 v4.1 变更摘要

| 项目 | v4.1 | v4.2 | 变更原因 |
|------|------|------|----------|
| 主控 | ESP32-S3 N16R8 | ESP32-S3 **N32R16V** | Flash 32MB 支持 OTA 双分区；PSRAM 16MB 支持更大缓冲 |
| 温湿度 | DHT22（单总线 GPIO4） | **DHT20（I2C 0x38）** | I2C 总线统一，减少 GPIO 占用，读取更稳定 |
| 摄像头 | OV2640 | **OV7670** | 按实际采购调整 |
| 电池 | 18650 2500mAh | Samsung 18650 **3000-3500mAh** | 续航提升 20-40% |
| 本地存储 | 无 | **Micro SD 卡模块** | 音效文件、本地记忆备份、日志 |
| 分区表 | 单应用 3MB + 模型 960KB | OTA 双分区 4MB×2 + 模型 2MB + 音频 2MB | 充分利用 32MB Flash |
| MQ-135 引脚 | 未分配 | **GPIO 4 (ADC)** | DHT20 改为 I2C 后释放 GPIO4 |
| 电池电压检测 | 未分配 | **GPIO 5 (ADC)** | 低电量自动管理 |
| BOM 状态 | 部分采购 | **全部已购** | 可以开始搭建 |

---

## 版本历史

| 版本 | 日期 | 更新内容 |
|------|------|---------|
| v1 | - | 初始方案（STM32 + ESP8266） |
| v2 | - | 升级为 ESP32-S3 单芯片方案 |
| v3 | - | 新增语音唤醒、硬件审核、功耗优化 |
| v4 | 2026-02 | 新增情绪系统、眼神追踪、环境感知、智能家居、趣味玩法 |
| v4.1 | 2026-02 | 完善开源唤醒词方案、补充 PlatformIO 配置示例、优化混合唤醒策略 |
| v4.2 | 2026-02 | 主控升级 N32R16V、DHT20 替换 DHT22、新增 SD 卡存储、BOM 全部到位 |

---

> **Wallace** - 不只是一个语音助手，而是一个有情感、有个性、会陪伴你的桌面 AI 伙伴。
