# Wallace v3：拟人化桌面 AI 机器人

> **目标**：构建一个具备"听、说、看"能力的桌面语音助手，支持**语音唤醒词**免触控交互。  
> **架构**：ESP32-S3（N16R8）单芯片全栈方案 + PC 服务端协同处理。  
> **版本更新**：v3 新增本地语音唤醒、硬件选型优化、功耗管理策略。

---

## 目录

- [1. 项目概述](#1-项目概述)
- [2. 系统架构](#2-系统架构)
  - [2.1 硬件链路](#21-硬件链路)
  - [2.2 数据流向（语音唤醒模式）](#22-数据流向语音唤醒模式)
- [3. 硬件设计与引脚规划](#3-硬件设计与引脚规划)
  - [3.1 音频输入（INMP441）](#31-音频输入inmp441)
  - [3.2 音频输出（MAX98357A）](#32-音频输出max98357a)
  - [3.3 视觉显示（GC9A01）](#33-视觉显示gc9a01)
  - [3.4 交互与存储](#34-交互与存储)
- [4. 软件实现路线](#4-软件实现路线)
  - [4.1 固件端（ESP32-S3）](#41-固件端esp32-s3)
  - [4.2 语音唤醒方案](#42-语音唤醒方案)
  - [4.3 服务端（PC）](#43-服务端pc)
- [5. 电源管理策略](#5-电源管理策略)
  - [5.1 供电架构](#51-供电架构)
  - [5.2 功耗预估与续航](#52-功耗预估与续航)
  - [5.3 低功耗优化策略](#53-低功耗优化策略)
- [6. 硬件采购清单（BOM）](#6-硬件采购清单bom)
  - [6.1 核心模块清单](#61-核心模块清单)
  - [6.2 采购注意事项](#62-采购注意事项)
- [7. 已知问题与解决方案](#7-已知问题与解决方案)
- [8. 市场方案对比参考](#8-市场方案对比参考)
- [附录 A：开发调试建议](#附录-a开发调试建议)

---

## 1. 项目概述

### 核心体验

| 能力 | 描述 | 实现方式 |
|------|------|----------|
| **听** | 语音唤醒 + 语音采集 | ESP32-S3 本地运行唤醒词模型，持续监听 |
| **看** | 圆形屏幕模拟眼睛 | 眨眼、注视、思考波形等拟人化表情 |
| **说** | 自然语音回复 | PC 端 LLM 生成文本，TTS 合成语音回传播放 |
| **续航** | 电池供电，语音唤醒待机 | 预计 3-5 天待机（2500mAh 电池） |

### v3 版本更新要点

1. **交互升级**：从"按住说话"升级为"语音唤醒词"免触控交互
2. **硬件审核**：修正 ESP32-S3 开发板 5V 引脚问题，优化电源方案
3. **功耗优化**：新增 WiFi 按需连接、CPU 动态调频等策略
4. **方案对标**：参考市场成熟产品（小爱同学、天猫精灵等）的技术路线

---

## 2. 系统架构

### 2.1 硬件链路

```
┌─────────────────────────────────────────────────────────────────┐
│                        ESP32-S3 N16R8                           │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │ WakeNet     │    │ Audio       │    │ Display     │         │
│  │ 唤醒词检测  │    │ I2S 音频流  │    │ SPI 屏幕    │         │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘         │
└─────────┼──────────────────┼──────────────────┼─────────────────┘
          │                  │                  │
    ┌─────▼─────┐      ┌─────▼─────┐      ┌─────▼─────┐
    │ INMP441   │      │ MAX98357A │      │ GC9A01    │
    │ I2S 麦克风│      │ I2S 功放  │      │ 圆形屏幕  │
    └───────────┘      └─────┬─────┘      └───────────┘
                             │
                       ┌─────▼─────┐
                       │ 4Ω 3W     │
                       │ 腔体喇叭  │
                       └───────────┘

┌─────────────────────────────────────────────────────────────────┐
│                        电源系统                                  │
│  18650 电池 ──▶ TP4056 充电保护 ──▶ MT3608 升压 5V ──▶ ESP32    │
│  (3.7-4.2V)      (Type-C 充电)       (DC-DC 2A)      (板载LDO)  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 数据流向（语音唤醒模式）

```
┌────────────────────────────────────────────────────────────────────┐
│  【待机监听状态】                                                   │
│  ┌──────────┐    ┌──────────┐                                     │
│  │ INMP441  │───▶│ WakeNet  │  持续监听，CPU 80MHz，WiFi 关闭     │
│  │ 麦克风   │    │ 唤醒检测 │  功耗 ~25mA                         │
│  └──────────┘    └────┬─────┘                                     │
│                       │ 检测到唤醒词                              │
│                       ▼                                           │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │【唤醒状态】                                                 │   │
│  │  1. 屏幕点亮，显示"聆听"动画                               │   │
│  │  2. WiFi 连接 PC 服务端                                    │   │
│  │  3. CPU 提升至 240MHz                                      │   │
│  └────────────────────────────────────────────────────────────┘   │
│                       │                                           │
│                       ▼                                           │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │【录音上传】                                                 │   │
│  │  ESP32 采集音频 ──WebSocket──▶ PC 服务端                   │   │
│  └────────────────────────────────────────────────────────────┘   │
│                       │                                           │
│                       ▼                                           │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │【PC 端处理】                                                │   │
│  │  VAD 静音检测 ──▶ ASR 语音识别 ──▶ LLM 生成回复 ──▶ TTS    │   │
│  │  (Silero-VAD)    (Faster-Whisper)  (Ollama/DeepSeek)  (Edge)│   │
│  └────────────────────────────────────────────────────────────┘   │
│                       │                                           │
│                       ▼                                           │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │【回复播放】                                                 │   │
│  │  PC 推送音频流 ──▶ ESP32 缓存 ──▶ I2S 播放 ──▶ 屏幕动效    │   │
│  └────────────────────────────────────────────────────────────┘   │
│                       │                                           │
│                       ▼                                           │
│  【返回待机】 关闭 WiFi，CPU 降频，屏幕熄灭                       │
└────────────────────────────────────────────────────────────────────┘
```

---

## 3. 硬件设计与引脚规划

> 以下为 ESP32-S3 DevKit 推荐引脚分配，可根据实际布线调整。

### 3.1 音频输入（INMP441）

| INMP441 引脚 | ESP32-S3 GPIO | 说明 |
|-------------|---------------|------|
| SCK (BCLK)  | GPIO 41       | I2S 位时钟 |
| WS (LRC)    | GPIO 42       | I2S 字选择 |
| SD (DOUT)   | GPIO 2        | I2S 数据输出 |
| VDD         | 3.3V          | 供电 |
| GND         | GND           | 接地 |
| L/R         | GND           | 接地 = 左声道（单声道模式） |

**注意**：麦克风收音孔在 PCB 底部，安装时确保朝向正确。

### 3.2 音频输出（MAX98357A）

| MAX98357A 引脚 | ESP32-S3 GPIO | 说明 |
|---------------|---------------|------|
| BCLK          | GPIO 15       | I2S 位时钟 |
| LRC           | GPIO 16       | I2S 字选择 |
| DIN           | GPIO 17       | I2S 数据输入 |
| Vin           | **5V**        | 供电（5V 推力更大） |
| GND           | GND           | 接地 |
| GAIN          | 悬空          | 默认 9dB 增益 |
| SD            | 悬空或接高    | 接低 = 关闭输出 |

**重要**：使用独立的 I2S 端口（I2S_NUM_1），避免与麦克风冲突。

### 3.3 视觉显示（GC9A01）

| GC9A01 引脚 | ESP32-S3 GPIO | 说明 |
|------------|---------------|------|
| SCL (SCK)  | GPIO 12       | SPI 时钟 |
| SDA (MOSI) | GPIO 11       | SPI 数据 |
| RES (RST)  | GPIO 10       | 复位 |
| DC         | GPIO 9        | 数据/命令选择 |
| CS         | GPIO 46       | 片选 |
| BLK        | GPIO 45       | 背光控制（PWM 调光） |
| VCC        | 3.3V          | 供电 |
| GND        | GND           | 接地 |

### 3.4 交互与存储

| 模块 | ESP32-S3 GPIO | 说明 |
|------|---------------|------|
| TTP223 触摸 | GPIO 1 (RTC GPIO) | 备用手动唤醒，支持深度睡眠唤醒 |
| SD 卡 CS | GPIO 38 | 可选，本地素材存储 |
| SD 卡复用 SPI | 与屏幕共用 | MOSI/MISO/CLK |

---

## 4. 软件实现路线

### 4.1 固件端（ESP32-S3）

**开发环境选择**：

| 环境 | 优点 | 缺点 | 推荐场景 |
|------|------|------|----------|
| ESP-IDF | 性能最优，官方支持 ESP-SR | 学习曲线陡 | 正式产品 |
| PlatformIO + Arduino | 上手快，库丰富 | 唤醒词集成稍复杂 | 快速原型 |
| ESPHome | 配置式开发，Home Assistant 集成好 | 灵活性受限 | 智能家居场景 |

**关键库/框架**：

| 功能 | 推荐方案 | 说明 |
|------|---------|------|
| 屏幕驱动 | LovyanGFX | 支持 GC9A01，Sprite 局部刷新 |
| 音频处理 | ESP-ADF | 官方音频框架，I2S + 编解码 |
| 语音唤醒 | ESP-SR (WakeNet) | 乐鑫官方，支持自定义唤醒词 |
| WebSocket | ArduinoWebSockets | 与 PC 服务端长连接 |
| WiFi 管理 | WiFiManager | 配网与重连 |

**拟人化动效实现**：

```cpp
// 使用 Sprite 局部刷新避免闪烁
LGFX_Sprite eyeSprite(&lcd);

void drawEye(int pupilX, int pupilY, bool blinking) {
    eyeSprite.fillSprite(TFT_WHITE);           // 眼白
    if (!blinking) {
        eyeSprite.fillCircle(pupilX, pupilY, 30, TFT_BLACK);  // 瞳孔
    } else {
        eyeSprite.fillRect(0, 100, 240, 40, TFT_BLACK);       // 眨眼线
    }
    eyeSprite.pushSprite(0, 0);
}
```

### 4.2 语音唤醒方案

**方案对比**：

| 方案 | 功耗 | 自定义唤醒词 | 开发难度 | 推荐度 |
|------|------|-------------|---------|-------|
| ESP-SR (WakeNet) | ~25mA | 付费定制 / 免费词库 | 中 | ⭐⭐⭐⭐⭐ |
| microWakeWord | ~30mA | 可自训练（需 GPU） | 中 | ⭐⭐⭐⭐ |
| 服务端流式检测 | ~80mA | 灵活 | 低 | ⭐⭐⭐ |

**推荐：ESP-SR (WakeNet)**

乐鑫官方方案，ESP32-S3 原生支持，文档完善。

```yaml
# 可用的免费唤醒词（ESP-SR 内置）
- "Hi 乐鑫" (Hi Lexin)
- "你好小智" 
- "Hi ESP"

# 自定义唤醒词需联系乐鑫付费定制，或使用 microWakeWord 自训练
```

**WakeNet 集成示例**（ESP-IDF）：

```c
#include "esp_wn_iface.h"
#include "esp_wn_models.h"

// 初始化唤醒词引擎
esp_wn_iface_t *wakenet = &WAKENET_MODEL;
model_iface_data_t *model_data = wakenet->create(model_name, DET_MODE_90);

// 在音频回调中检测
int result = wakenet->detect(model_data, audio_buffer);
if (result > 0) {
    printf("Wake word detected!\n");
    // 触发唤醒流程
}
```

### 4.3 服务端（PC）

**技术栈**：Python 3.10+ / FastAPI / WebSocket

**处理流水线**：

```python
# server.py 核心流程
from fastapi import FastAPI, WebSocket
import faster_whisper
import edge_tts
from langchain_ollama import ChatOllama

app = FastAPI()

# 初始化模型
whisper_model = faster_whisper.WhisperModel("large-v3-turbo")
llm = ChatOllama(model="deepseek-r1:8b")

@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
    await websocket.accept()
    
    while True:
        # 1. 接收音频数据
        audio_data = await websocket.receive_bytes()
        
        # 2. VAD 检测是否说完
        if not is_speech_ended(audio_data):
            continue
            
        # 3. ASR 语音识别
        segments, _ = whisper_model.transcribe(audio_data)
        text = "".join([s.text for s in segments])
        
        # 4. LLM 生成回复
        response = llm.invoke(text)
        
        # 5. TTS 合成语音
        audio_stream = edge_tts.Communicate(response.content, voice="zh-CN-XiaoxiaoNeural")
        
        # 6. 流式推送音频
        async for chunk in audio_stream.stream():
            if chunk["type"] == "audio":
                await websocket.send_bytes(chunk["data"])
```

**推荐模型配置**：

| 组件 | 推荐方案 | 硬件需求 | 延迟 |
|------|---------|---------|------|
| ASR | faster-whisper large-v3-turbo | CPU 可用，GPU 更快 | 1-3s |
| LLM | Ollama + DeepSeek-R1 7B/8B | 16GB+ 内存 | 2-5s |
| TTS | edge-tts (zh-CN-XiaoxiaoNeural) | 无（在线服务） | <1s |

---

## 5. 电源管理策略

### 5.1 供电架构

```
18650 电池 (3.7V, 2500mAh)
    │
    ▼
TP4056 充电保护模块 (Type-C 输入)
    │
    ▼
MT3608 升压模块 ──────▶ 5V 输出
    │                      │
    │                      ├──▶ MAX98357A 功放 (Vin)
    │                      │
    │                      └──▶ ESP32-S3 开发板 (5V Pin)
    │                               │
    │                               └──▶ 板载 LDO ──▶ 3.3V
    │                                                  │
    │                                                  ├──▶ INMP441
    │                                                  └──▶ GC9A01
```

### 5.2 功耗预估与续航

| 工作状态 | 功耗 | 说明 |
|---------|------|------|
| 语音唤醒待机 | ~25mA | 麦克风 + WakeNet 持续运行，WiFi 关闭 |
| 唤醒后录音 | ~80mA | WiFi 连接，音频上传 |
| 播放回复 | ~150mA | 功放全功率，屏幕点亮 |
| 深度睡眠 | ~10μA | 仅保留 RTC，触摸唤醒 |

**续航估算**（2500mAh 电池）：

| 使用模式 | 预估续航 |
|---------|---------|
| 纯语音唤醒待机 | 约 100 小时（4 天） |
| 每天 50 次对话（每次 30 秒） | 约 3-4 天 |
| 深度睡眠 + 触摸唤醒 | 数月 |

### 5.3 低功耗优化策略

**1. WiFi 按需连接**

```cpp
void onWakeWordDetected() {
    WiFi.begin(ssid, password);  // 唤醒后才连接
    // ... 处理对话 ...
    WiFi.disconnect(true);       // 对话结束断开
    WiFi.mode(WIFI_OFF);
}
```

**2. CPU 动态调频**

```cpp
// 待机监听：80MHz
setCpuFrequencyMhz(80);

// 检测到唤醒词：提升至 240MHz
void onWakeWordDetected() {
    setCpuFrequencyMhz(240);
}
```

**3. 屏幕背光控制**

```cpp
// 待机时关闭背光
ledcWrite(BLK_CHANNEL, 0);

// 唤醒时点亮（PWM 调光）
ledcWrite(BLK_CHANNEL, 200);  // 0-255
```

**4. 混合睡眠模式**（可选）

```cpp
// 长时间无交互进入深度睡眠，仅保留触摸唤醒
if (idleTime > 30 * 60 * 1000) {  // 30 分钟
    esp_sleep_enable_ext0_wakeup(GPIO_NUM_1, HIGH);  // TTP223
    esp_deep_sleep_start();
}
```

---

## 6. 硬件采购清单（BOM）

### 6.1 核心模块清单

| 类别 | 名称 | 规格要点 | 数量 | 参考价 | 备注 |
|------|------|---------|------|-------|------|
| **主控** | ESP32-S3 开发板 | N16R8（16M Flash / 8M PSRAM），Type-C，双 USB | 2 | ¥35-50 | ⚠️ 检查 5V 引脚 |
| **显示** | 1.28 寸 GC9A01 屏幕 | 圆形 LCD，SPI 接口，带 PCB 底板 | 1 | ¥15-25 | 必须带底板 |
| **音频输入** | INMP441 麦克风 | I2S 数字麦克风，全向拾音 | 2 | ¥8-12 | 收音孔朝下 |
| **音频输出** | MAX98357A 功放 | I2S 接口，3W D 类功放 | 2 | ¥6-10 | 需 5V 供电 |
| **发声** | 腔体喇叭 | 4Ω 3W，带音腔外壳 | 1 | ¥5-10 | 必须带音腔 |
| **电池** | 18650 电池 + 电池盒 | 2500mAh+，带保护板 | 1 组 | ¥15-25 | - |
| **充电** | TP4056 充电模块 | Type-C 接口，带保护电路 | 2 | ¥3-5 | - |
| **升压** | MT3608 升压模块 | DC-DC 2A，可调输出 | 2 | ¥2-4 | 调至 5V |
| **交互** | TTP223 触摸模块 | 电容式，点动模式 | 2 | ¥1-2 | 备用手动唤醒 |
| **存储** | Micro SD 卡模块 | SPI 接口 | 1 | ¥3-5 | 可选 |
| **开关** | 拨动开关 | SS12D00 或类似 | 5 | ¥0.5 | 总电源控制 |
| **连接** | 杜邦线 + 排针 | 公对母、母对母，10cm | 1 批 | ¥10 | 尽量短 |
| **滤波** | 电解电容 100μF | 16V，直插 | 5 | ¥1 | 升压输出滤波 |

**总成本预估**：¥150-200（含冗余备件）

### 6.2 采购注意事项

#### ⚠️ ESP32-S3 开发板 5V 引脚问题

**问题描述**：淘宝/速卖通常见的中国版 ESP32-S3 N16R8 开发板，**5V 引脚默认不输出 5V**（实测仅 1.8V），因为板上的 IN-OUT 焊盘默认断开。

**影响**：MAX98357A 功放无法正常工作，喇叭几乎没声音。

**解决方案**：
1. 收到开发板后，用烙铁**短接 IN-OUT 焊盘**
2. 或直接从 MT3608 升压模块输出 5V 给功放供电（推荐）

```
开发板背面示意：

  ┌─────────────────┐
  │    ESP32-S3     │
  │                 │
  │  [IN-OUT] ← 焊接短接这里
  │  [USB-OTG]      │
  │  [RGB]          │
  └─────────────────┘
```

#### 其他注意事项

1. **ESP32-S3 必须是 N16R8 版本**：16MB Flash + 8MB PSRAM，否则无法运行唤醒词模型
2. **屏幕必须带 PCB 底板**：裸屏 FPC 排线极难焊接
3. **喇叭必须带音腔**：无音腔的小喇叭音量和音质都很差
4. **杜邦线尽量短**：I2S 信号对线长敏感，超过 10cm 可能有杂音
5. **MT3608 输出端加滤波电容**：减少开关电源纹波对音频的干扰

---

## 7. 已知问题与解决方案

### 7.1 I2S 驱动冲突

**问题**：同时使用 INMP441（输入）和 MAX98357A（输出）时，可能遇到驱动冲突。

**错误信息**：`CONFLICT! The new i2s driver can't work along with the legacy i2s driver`

**解决方案**：
- 统一使用新版 ESP-IDF I2S 驱动，不要混用旧版 `driver/i2s.h`
- 输入使用 `I2S_NUM_0`，输出使用 `I2S_NUM_1`
- 推荐使用 ESP-ADF 框架统一管理音频

### 7.2 升压模块噪音

**问题**：MT3608 开关电源可能与 D 类功放产生拍频干扰，导致喇叭有底噪。

**解决方案**：
1. MT3608 输出端并联 100μF 电解电容
2. 布线时让升压模块远离麦克风和功放
3. I2S 信号线尽量短（<5cm）
4. 如果噪音严重，考虑换用 IP5306 充放一体模块

### 7.3 唤醒词误触发

**问题**：电视、音乐等环境音可能误触发唤醒词。

**解决方案**：
1. 选择独特的唤醒词（避免常见词汇）
2. 调整 WakeNet 检测阈值
3. 增加二次确认逻辑（如检测到唤醒词后等待后续语音）

---

## 8. 市场方案对比参考

### 8.1 商业产品技术路线

| 产品 | 主控芯片 | 唤醒方案 | 供电方式 | 功耗 |
|------|---------|---------|---------|------|
| 小爱同学 mini | 全志 R16 | 主控本地检测 | 插电 | ~2.5W |
| 天猫精灵 | 联发科 MT8516 | 主控本地检测 | 插电 | ~2.5W |
| Amazon Echo | 专用芯片 | 硬件唤醒词检测 | 插电 | ~3W |
| **Wallace (本方案)** | ESP32-S3 | WakeNet 本地检测 | 电池 | ~0.1W |

### 8.2 方案选型参考

| 方案 | 唤醒功耗 | 电池续航 | 成本 | 开发难度 | 适用场景 |
|------|---------|---------|------|---------|---------|
| 插电 + 高性能主控 | 2-3W | 不适用 | 高 | 中 | 固定位置音箱 |
| 专用唤醒芯片 + MCU | <1mW | 数月 | 高 | 高 | 耳机、遥控器 |
| **ESP32-S3 本地唤醒** | ~25mA | 3-5 天 | 低 | 中 | 桌面便携设备 |

**结论**：ESP32-S3 本地唤醒方案在成本、功耗、开发难度之间取得了良好平衡，适合 Wallace 项目的桌面便携定位。

---

## 附录 A：开发调试建议

### A.1 开发顺序建议

```
1. 硬件验证
   ├── ESP32-S3 开发板上电测试
   ├── 检查 5V 引脚电压（必要时焊接 IN-OUT）
   └── 各模块单独测试

2. 基础功能
   ├── GC9A01 屏幕驱动（LovyanGFX）
   ├── INMP441 麦克风录音测试
   └── MAX98357A 音频播放测试

3. 核心功能
   ├── 语音唤醒词集成（ESP-SR）
   ├── WiFi + WebSocket 通信
   └── PC 服务端联调

4. 优化完善
   ├── 低功耗模式调试
   ├── 拟人化动效实现
   └── 整机组装测试
```

### A.2 调试工具

| 工具 | 用途 |
|------|------|
| USB 串口 | 日志输出、固件烧录 |
| 万用表 | 电压/电流测量 |
| 逻辑分析仪 | I2S/SPI 信号分析 |
| Audacity | 音频录制/播放测试 |

### A.3 常用调试命令

```bash
# 监控 ESP32 串口日志
idf.py -p /dev/ttyUSB0 monitor

# 烧录固件
idf.py -p /dev/ttyUSB0 flash

# PlatformIO 编译上传
pio run -t upload

# 查看 ESP32 内存使用
idf.py size-components
```

---

## 版本历史

| 版本 | 日期 | 更新内容 |
|------|------|---------|
| v1 | - | 初始方案（STM32 + ESP8266） |
| v2 | - | 升级为 ESP32-S3 单芯片方案 |
| v3 | 2026-02 | 新增语音唤醒、硬件审核、功耗优化、市场对比 |

---

> **Wallace** - 一个有眼睛、会说话、能听懂你的桌面 AI 伙伴。
