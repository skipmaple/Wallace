# STM32F411CEU6 语音交互方案（统一实现计划）

## 目标与可行性概览
目标：STM32F411CEU6 采集语音，经 Wi‑Fi 发送到本地电脑完成 ASR→LLM→TTS，再把 TTS 音频回传播放；整机由电池供电并可通过电源开关控制，尽量实现一周续航。

可行性结论（基于现有清单）：
- 已具备：STM32F411CEU6、INMP441（I2S 麦克风）、ESP8266（Wi‑Fi）、被动扬声器、供电线材与电源开关、下载调试工具。
- 关键缺口：音频功放/DAC、充电管理/保护、高效率稳压。
- 一周续航可行但依赖低功耗策略与电池容量配置。

## 现有可用模块（来自清单）
- STM32F411CEU6 开发板（清单中含“STM32F411CEU6 不焊但送排针”）
- INMP441 全向麦克风模块（I2S）
- ESP8266 串口 Wi‑Fi / NodeMCU 模块
- 扬声器小喇叭 4Ω3W（被动）
- ST-LINK V2 / J-Link OB（下载与调试）
- 18650 电池/电池盒、电源线材
- 电源模块（AMS1117、DC‑DC 多路输出）
- 电源开关（船形/拨动）

## 系统链路（端到端）
1. INMP441 → STM32F411（I2S 采集 PCM）
2. STM32F411 → ESP8266（UART/SPI）
3. ESP8266 → 电脑（HTTP/WebSocket/MQTT 上传音频流）
4. 电脑：ASR → LLM → TTS
5. 电脑 → ESP8266 → STM32F411（回传 PCM）
6. STM32F411 → 音频 DAC/功放 → 扬声器

## 关键硬件设计
### 音频采集
- INMP441 供电 3.3V，I2S 接 STM32（BCLK/LRCLK/DATA）
- 采样建议：16kHz/16bit/单声道（降低带宽与功耗）

### Wi‑Fi 通信
- STM32F411 ↔ ESP8266：UART（≥115200）
- 协议建议：
  - 上行：HTTP POST 或 WebSocket 推送 PCM/压缩音频
  - 下行：WebSocket 推送 TTS PCM（优先）或轮询拉取
- 备注：ESP8266 负责联网与 TCP/IP，STM32 只做串口通信

### 音频播放
- 被动扬声器无法直接由 STM32 驱动
- 必需：I2S DAC + 功放（或 PWM + 功放，但音质与效率较差）
- 现有清单可选替代：蓝牙音响制作套件（若含功放，可做过渡方案）

### 供电与电源开关（贯穿系统）
- 电池：18650 电池组
- 开关：船形/拨动开关串联在电池输出端
- 稳压：高效率 DC‑DC 输出 3.3V/5V 供给 STM32/ESP8266/音频链路
- 充电/保护：需 1S 充电管理与保护（建议补齐）

## 续航目标（一周）与功耗策略
### 功耗策略（必须）
- 录音触发后才唤醒 Wi‑Fi，上行/下行结束即关闭或深度睡眠
- STM32 空闲进入低功耗模式，仅保留按键/唤醒源
- 音频采集/播放采用低采样率与短时会话

### 续航估算（方法）
- 估算公式：$T=\frac{C}{I}$（小时），$C$ 为电池容量，$I$ 为平均电流
- 若需一周：$T≈168\text{h}$，则平均电流应尽量接近 $\frac{C}{168}$
- 需要根据实际负载（ESP8266 通信占比、音频播放时长）配置电池容量与并联数量

## 软件实现计划
### STM32 侧
- I2S 采集 INMP441 PCM
- 串口分帧发送到 ESP8266
- 接收回传 PCM 并送入音频输出链路
- 按键触发录音/上传，空闲低功耗

### 电脑侧
- ASR：本地 Whisper / faster-whisper
- LLM：本地推理（如 llama.cpp / ollama）
- TTS：本地 TTS（如 Piper）
- 提供服务端接口：
  - /audio/upload：接收上传音频
  - /audio/tts：下发 TTS PCM

## 需要补充的器件（关键缺口，含型号与理由）
- MAX98357A I2S 数字功放
  - 理由：直接吃 I2S，省去 DAC，单芯片即可驱动 4Ω 小喇叭，电路简单、效率高。
- PCM5102A I2S DAC + PAM8403 D 类功放
  - 理由：音质更稳定，功放容易买到；两级方案可替换性强。
- TP4056（带保护版）1S 充电管理
  - 理由：常见易买，支持 1 节 18650 充电与保护，成本低。
- MT3608 升压模块 或 MP1584 降压模块（二选一或组合）
  - 理由：高效率 DC‑DC，降低线性稳压损耗，延长续航。
- DW01A + 8205A（1S 保护板，若 TP4056 无保护）
  - 理由：提供过充/过放/过流保护，提升安全性与电池寿命。

## 采购清单建议（只需买部分）
### 音频链路（二选一）
- 方案A（更简单）：MAX98357A（单芯片 I2S 功放）
- 方案B（可替换性更强）：PCM5102A + PAM8403

### 电池充电与保护
- 必选：TP4056（带保护版）
- 若买到的是无保护版 TP4056：再加 DW01A + 8205A（二选一，不重复买）

### 稳压模块（按电压需求选择）
- 只需 3.3V：MP1584 降压模块
- 需要 5V（如功放或外设）再转 3.3V：MT3608 升压 + MP1584 降压

### 结论（最小购买组合）
- 音频：MAX98357A 或 PCM5102A+PAM8403（二选一）
- 充电/保护：TP4056（带保护版）
- 稳压：MP1584（如需 5V 再加 MT3608）

## 落地步骤（建议顺序）
1. 搭建 STM32 + INMP441 采集与串口传输
2. ESP8266 联网，打通与电脑的音频上传/回传
3. 完成电脑端 ASR→LLM→TTS 流程
4. 增加音频 DAC/功放并驱动扬声器播放
5. 引入电池、开关与高效电源管理，调优功耗以逼近一周续航
